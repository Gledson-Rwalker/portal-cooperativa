{% extends "layout.html" %}

{% block title %}Detalhes: {{ treinamento.titulo }}{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>{{ treinamento.titulo }}</h1>
    </div>
    
    <p><strong>Data:</strong> {{ data_formatada }}</p>
    <p><strong>Instrutor:</strong> {{ treinamento.instrutor }}</p>
    <p>{{ treinamento.descricao }}</p>

    <hr>
    
    <div>
        <h3>Acesso à Sala Virtual</h3>
        <!-- A lógica do contador já está aqui e correta -->
        <div id="enter-button-container" style="display: none;">
            <a href="//{{ treinamento.link_meet.replace('https://', '').replace('http://', '') }}" class="btn btn-success" target="_blank">ENTRAR NA SALA</a>
        </div>
        <div id="countdown-container">
            <p>O acesso será liberado em:</p>
            <h3 id="countdown-timer" style="color: #0d6efd;">Calculando...</h3>
        </div>
    </div>

    <hr>

    <div>
        <h3>Lista de Presença</h3>
        <!-- --- LÓGICA DO BOTÃO DE PRESENÇA CORRIGIDA E NO LUGAR CERTO --- -->
        {% if presenca_ja_confirmada %}
            <p style="color: #198754; font-weight: bold;">Sua presença foi confirmada com sucesso!</p>
            <a href="{{ url_for('generate_certificate_cooperado', training_id=treinamento.id) }}" class="btn btn-success" target="_blank">
                Gerar Certificado
            </a>
        {% elif treinamento.presenca_liberada %}
            <form action="{{ url_for('confirmar_presenca', id=treinamento.id) }}" method="post">
                <button type="submit" class="btn btn-primary">Confirmar Minha Presença</button>
            </form>
        {% else %}
            <p>A lista de presença será liberada pelo instrutor ao final do treinamento.</p>
        {% endif %}
    </div>

    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="margin-top: 1rem;">Voltar para a Lista</a>
</div>

<!-- O JAVASCRIPT DO CONTADOR (NÃO MUDA) -->
<script>
    const countdownContainer = document.getElementById('countdown-container');
    const countdownElement = document.getElementById('countdown-timer');
    const buttonContainer = document.getElementById('enter-button-container');
    const trainingISOString = "{{ training_iso_time }}";
    const trainingTime = new Date(trainingISOString).getTime();
    const unlockTime = trainingTime - (5 * 60 * 1000);
    const timerInterval = setInterval(function() {
        const now = new Date().getTime();
        const distance = unlockTime - now;
        if (distance < 0) {
            clearInterval(timerInterval);
            countdownContainer.style.display = 'none';
            buttonContainer.style.display = 'block';
            return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        let countdownText = "";
        if (days > 0) countdownText += days + "d ";
        if (hours > 0 || days > 0) countdownText += hours + "h ";
        countdownText += minutes + "m " + seconds + "s ";
        countdownElement.innerHTML = countdownText;
    }, 1000);
</script>
{% endblock %}