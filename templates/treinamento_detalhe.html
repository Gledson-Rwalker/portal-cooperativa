{% extends "layout.html" %}

{% block title %}Detalhes: {{ treinamento.titulo }}{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>{{ treinamento.titulo }}</h1>
    </div>
    
    <p><strong>Data:</strong> {{ data_formatada }}</p>
    <p><strong>Instrutor:</strong> {{ treinamento.instrutor }}</p>
    <p>{{ treinamento.descricao }}</p>

    <hr>
    
    <div>
        <h3>Acesso à Sala Virtual</h3>
        
        <!-- --- ESTRUTURA DO CONTADOR AQUI --- -->
        <!-- O botão começa escondido -->
        <div id="enter-button-container" style="display: none;">
            <a href="//{{ treinamento.link_meet.replace('https://', '').replace('http://', '') }}" class="btn btn-success" target="_blank">ENTRAR NA SALA</a>
        </div>

        <!-- O contador começa visível -->
        <div id="countdown-container">
            <p>O acesso será liberado em:</p>
            <!-- O JavaScript vai preencher este h3 -->
            <h3 id="countdown-timer" style="color: #0d6efd;">Calculando...</h3>
        </div>
    </div>

    <hr>

    <div>
        <h3>Lista de Presença</h3>
        <!-- ... (o resto da lógica da lista de presença continua a mesma) ... -->
    </div>

    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="margin-top: 1rem;">Voltar para a Lista</a>
</div>

<!-- --- O JAVASCRIPT QUE FAZ A MÁGICA --- -->
<script>
    // Pega os elementos da página
    const countdownContainer = document.getElementById('countdown-container');
    const countdownElement = document.getElementById('countdown-timer');
    const buttonContainer = document.getElementById('enter-button-container');

    // Pega a data do treinamento que o Python nos enviou
    const trainingISOString = "{{ training_iso_time }}";
    const trainingTime = new Date(trainingISOString).getTime();

    // Calcula o momento exato em que o botão deve ser liberado (5 minutos antes)
    const unlockTime = trainingTime - (5 * 60 * 1000);

    // Função que atualiza o contador a cada segundo
    const timerInterval = setInterval(function() {
        const now = new Date().getTime();
        const distance = unlockTime - now;

        // Se o tempo já passou, libera o botão
        if (distance < 0) {
            clearInterval(timerInterval); // Para o contador
            countdownContainer.style.display = 'none'; // Esconde o contador
            buttonContainer.style.display = 'block'; // Mostra o botão
            return;
        }

        // Calcula dias, horas, minutos e segundos
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Monta o texto do contador e exibe na tela
        let countdownText = "";
        if (days > 0) countdownText += days + "d ";
        if (hours > 0 || days > 0) countdownText += hours + "h ";
        countdownText += minutes + "m " + seconds + "s ";
        countdownElement.innerHTML = countdownText;

    }, 1000); // Roda a cada 1000ms (1 segundo)
</script>
{% endblock %}